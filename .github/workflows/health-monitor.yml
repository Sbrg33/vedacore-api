name: Health Monitor

permissions:
  contents: read
  issues: write

on:
  schedule:
    # Run every 5 minutes during business hours (UTC)
    - cron: '*/5 8-18 * * 1-5'
    # Run hourly outside business hours
    - cron: '0 * * * *'
  workflow_dispatch: {}

concurrency:
  group: health-monitor
  cancel-in-progress: true

jobs:
  health-check:
    runs-on: ubuntu-latest
    steps:
      - name: Check API Health
        run: |
          echo "ðŸ¥ Checking VedaCore API Health..."
          
          # Basic connectivity test
          if curl -fsS --connect-timeout 10 --max-time 30 http://${{ secrets.DO_HOST }}/api/v1/health/up; then
            echo "âœ… Basic health check passed"
          else
            echo "âŒ Basic health check failed"
            exit 1
          fi
          
          # Readiness check
          if curl -fsS --connect-timeout 10 --max-time 30 http://${{ secrets.DO_HOST }}/api/v1/health/ready; then
            echo "âœ… Readiness check passed"
          else
            echo "âŒ Readiness check failed"
            exit 1
          fi
          
          # Version verification
          VERSION_INFO=$(curl -fsS http://${{ secrets.DO_HOST }}/api/v1/health/version 2>/dev/null || echo "{}")
          echo "ðŸ“Š Service Info: $VERSION_INFO"
          
          echo "ðŸŽ‰ All health checks passed!"

      - name: Notify on Failure (deduplicated)
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const title = `ðŸš¨ API Health Check Failed - ${new Date().toISOString().split('T')[0]}`;
            const body = `## ðŸš¨ VedaCore API Health Check Failed
            
            **Time:** ${new Date().toISOString()}
            **Workflow:** ${{ github.workflow }}
            **Run:** ${{ github.run_id }}
            
            ### Details
            The automated health monitoring detected an issue with the VedaCore API deployment.
            
            ### Next Steps
            1. Check the DigitalOcean droplet status
            2. Verify the container is running: \`docker ps\`
            3. Check container logs: \`docker logs vedacore-api\`
            4. Restart if necessary: \`docker restart vedacore-api\`
            
            ### Links
            - [Workflow Run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            - [Repository](https://github.com/${{ github.repository }})
            `;
            
            // Check for recent open monitoring issue to avoid duplicates
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'monitoring',
              state: 'open',
              per_page: 5,
              sort: 'created',
              direction: 'desc'
            });
            const existing = issues.find(i => i.title.startsWith('ðŸš¨ API Health Check Failed'));
            if (existing) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existing.number,
                body: `Additional failure detected at ${new Date().toISOString()} â€” see workflow run: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}`
              });
            } else {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title,
                body,
                labels: ['bug', 'production', 'monitoring']
              });
            }

  diagnose:
    needs: health-check
    if: failure()
    runs-on: ubuntu-latest
    steps:
      - name: SSH diagnose (container + local health)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DO_HOST }}
          username: ${{ secrets.DO_USER }}
          key: ${{ secrets.DO_SSH_KEY }}
          port: ${{ secrets.DO_PORT || '22' }}
          script_stop: false
          script: |
            set -euo pipefail
            echo "== Docker containers =="
            docker ps --format 'table {{.Names}}\t{{.Status}}\t{{.Ports}}' || true
            echo
            echo "== Recent logs (vedacore-api) =="
            docker logs --tail 200 vedacore-api 2>&1 || true
            echo
            echo "== Local health checks =="
            for P in 80 8000; do
              echo "-- Trying port $P --"
              curl -sS -o /dev/null -w "HTTP %\{http_code\}\n" http://127.0.0.1:${P}/api/v1/health/up || true
              curl -sS http://127.0.0.1:${P}/api/v1/health/version 2>/dev/null || true
              echo
            done
            echo "== Env sanity (masked) =="
            env | sed -E 's/(AUTH_[A-Z_]+=).*/\1***MASKED***/; s/(CORS_ALLOWED_ORIGINS=).*/\1***MASKED***/' | sort || true
            
            // Create an issue for tracking
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸš¨ API Health Check Failed - ${new Date().toISOString().split('T')[0]}`,
              body: issue_body,
              labels: ['bug', 'production', 'monitoring']
            });
