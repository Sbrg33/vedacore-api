name: Deploy (SSH via GHCR)

on:
  # Manual deploy with overrides
  workflow_dispatch:
    inputs:
      tag:
        description: "Image tag to deploy (default: latest)"
        default: "latest"
        required: false
      public_url:
        description: "Public URL to test (default: https://api.vedacore.io)"
        default: "https://api.vedacore.io"
        required: false
  # Auto-deploy when build & push succeeds on main
  workflow_run:
    workflows: ["Build & Push Image (GHCR)"]
    types: [completed]

jobs:
  deploy:
    runs-on: ubuntu-latest
    # Only auto-deploy successful runs on main, or any manual dispatch
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'workflow_run' &&
       github.event.workflow_run.conclusion == 'success' &&
       github.event.workflow_run.head_branch == 'main')
    concurrency:
      group: deploy-vedacore-api
      cancel-in-progress: true
    env:
      APP_DIR: /opt/vedacore-api
      PORT: 8000
    steps:
      - name: Compute image tag
        id: tag
        run: |
          if [ "${{ github.event_name }}" = "workflow_run" ]; then
            # Use long SHA tag published by build workflow
            echo "tag=sha-${{ github.event.workflow_run.head_sha }}" >> "$GITHUB_OUTPUT"
          else
            echo "tag=${{ inputs.tag || 'latest' }}" >> "$GITHUB_OUTPUT"
          fi
          echo "Computed tag: $(cat $GITHUB_OUTPUT)"
      - name: Deploy on server (pull image)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DO_HOST }}
          username: ${{ secrets.DO_USER }}
          key: ${{ secrets.DO_SSH_KEY }}
          port: ${{ secrets.DO_PORT || '22' }}
          script_stop: true
          envs: AUTH_JWT_SECRET,CORS_ALLOWED_ORIGINS,GHCR_USERNAME,GHCR_TOKEN,PORT,REDIS_URL
        env:
          AUTH_JWT_SECRET: ${{ secrets.AUTH_JWT_SECRET }}
          CORS_ALLOWED_ORIGINS: ${{ secrets.CORS_ALLOWED_ORIGINS }}
          GHCR_USERNAME: ${{ secrets.GHCR_USERNAME }}
          GHCR_TOKEN: ${{ secrets.GHCR_TOKEN }}
          REDIS_URL: ${{ secrets.REDIS_URL }}
          script: |
            set -euo pipefail
            IMAGE="ghcr.io/${{ github.repository_owner }}/vedacore-api:${{ steps.tag.outputs.tag }}"
            # Check required environment variables
            : ${GHCR_USERNAME:?GHCR_USERNAME not set}
            : ${GHCR_TOKEN:?GHCR_TOKEN not set}
            : ${AUTH_JWT_SECRET:?AUTH_JWT_SECRET not set}
            : ${CORS_ALLOWED_ORIGINS:?CORS_ALLOWED_ORIGINS not set}
            # Login to GHCR (read:packages token)
            docker login ghcr.io -u "$GHCR_USERNAME" -p "$GHCR_TOKEN"
            # Pull & restart container
            docker rm -f vedacore-api || true
            docker pull "$IMAGE"
            docker run -d --rm --name vedacore-api \
              -p ${PORT}:8000 \
              -e ENVIRONMENT=production \
              -e VC_ENV=remote \
              -e AUTH_JWT_SECRET="${AUTH_JWT_SECRET}" \
              -e CORS_ALLOWED_ORIGINS="${CORS_ALLOWED_ORIGINS}" \
              ${REDIS_URL:+ -e REDIS_URL="${REDIS_URL}"} \
              "$IMAGE"
            # Wait for readiness
            i=0; ok=0; \
            while [ $i -lt 45 ]; do \
              if curl -fsS http://127.0.0.1:${PORT}/api/v1/health/ready >/dev/null 2>&1; then ok=1; break; fi; \
              i=$((i+1)); sleep 2; \
            done; \
            if [ $ok -eq 1 ]; then echo "✅ Ready"; else echo "❌ Not ready"; docker logs vedacore-api || true; exit 1; fi

  post-smoke:
    runs-on: ubuntu-latest
    needs: deploy
    steps:
      - name: Public API smoke test
        run: |
          set -euo pipefail
          if [ "${{ github.event_name }}" = "workflow_run" ]; then
            PUBLIC_URL="https://api.vedacore.io"
          else
            PUBLIC_URL="${{ inputs.public_url || 'https://api.vedacore.io' }}"
          fi
          
          echo "🔍 Testing public readiness: $PUBLIC_URL/api/v1/health/ready"
          if curl -fsS "$PUBLIC_URL/api/v1/health/ready" >/dev/null; then
            echo "✅ Public readiness check passed"
          else
            echo "❌ Public readiness check failed"
            exit 1
          fi
          
          echo "🔍 Testing docs endpoint: $PUBLIC_URL/api/docs"
          if curl -fsS "$PUBLIC_URL/api/docs" >/dev/null; then
            echo "✅ Public docs endpoint accessible"
          else
            echo "❌ Public docs endpoint failed"
            exit 1
          fi
          
          echo "✅ Post-deploy public smoke tests completed successfully"
