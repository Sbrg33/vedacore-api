name: Deploy (SSH via GHCR)

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Image tag to deploy (default: latest)"
        default: "latest"
        required: false
      public_url:
        description: "Public URL to test (default: https://api.vedacore.io)"
        default: "https://api.vedacore.io"
        required: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      APP_DIR: /opt/vedacore-api
      PORT: 8123
    steps:
      - name: Deploy on server (pull image)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DO_HOST }}
          username: ${{ secrets.DO_USER }}
          key: ${{ secrets.DO_SSH_KEY }}
          port: ${{ secrets.DO_PORT || '22' }}
          script_stop: true
          envs: AUTH_JWT_SECRET,CORS_ALLOWED_ORIGINS,GHCR_USERNAME,GHCR_TOKEN,PORT
        env:
          AUTH_JWT_SECRET: ${{ secrets.AUTH_JWT_SECRET }}
          CORS_ALLOWED_ORIGINS: ${{ secrets.CORS_ALLOWED_ORIGINS }}
          GHCR_USERNAME: ${{ secrets.GHCR_USERNAME }}
          GHCR_TOKEN: ${{ secrets.GHCR_TOKEN }}
          script: |
            set -euo pipefail
            IMAGE="ghcr.io/${{ github.repository_owner }}/vedacore-api:${{ inputs.tag || 'latest' }}"
            # Check required environment variables
            : ${GHCR_USERNAME:?GHCR_USERNAME not set}
            : ${GHCR_TOKEN:?GHCR_TOKEN not set}
            : ${AUTH_JWT_SECRET:?AUTH_JWT_SECRET not set}
            : ${CORS_ALLOWED_ORIGINS:?CORS_ALLOWED_ORIGINS not set}
            # Login to GHCR (read:packages token)
            docker login ghcr.io -u "$GHCR_USERNAME" -p "$GHCR_TOKEN"
            # Pull & restart container
            docker rm -f vedacore-api || true
            docker pull "$IMAGE"
            docker run -d --rm --name vedacore-api \
              -p 80:8000 \
              -e ENVIRONMENT=production \
              -e VC_ENV=remote \
              -e AUTH_JWT_SECRET="${AUTH_JWT_SECRET}" \
              -e CORS_ALLOWED_ORIGINS="${CORS_ALLOWED_ORIGINS}" \
              "$IMAGE"
            # Wait for readiness
            i=0; ok=0; \
            while [ $i -lt 45 ]; do \
              if curl -fsS http://127.0.0.1:80/api/v1/health/ready >/dev/null 2>&1; then ok=1; break; fi; \
              i=$((i+1)); sleep 2; \
            done; \
            if [ $ok -eq 1 ]; then echo "âœ… Ready"; else echo "âŒ Not ready"; docker logs vedacore-api || true; exit 1; fi

  post-smoke:
    runs-on: ubuntu-latest
    needs: deploy
    steps:
      - name: Public API smoke test
        run: |
          set -euo pipefail
          PUBLIC_URL="${{ inputs.public_url || 'https://api.vedacore.io' }}"
          
          echo "ğŸ” Testing public readiness: $PUBLIC_URL/api/v1/health/ready"
          if curl -fsS "$PUBLIC_URL/api/v1/health/ready" >/dev/null; then
            echo "âœ… Public readiness check passed"
          else
            echo "âŒ Public readiness check failed"
            exit 1
          fi
          
          echo "ğŸ” Testing docs endpoint: $PUBLIC_URL/api/docs"
          if curl -fsS "$PUBLIC_URL/api/docs" >/dev/null; then
            echo "âœ… Public docs endpoint accessible"
          else
            echo "âŒ Public docs endpoint failed"
            exit 1
          fi
          
          echo "âœ… Post-deploy public smoke tests completed successfully"
